<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RLtools Zoo</title>
    <link rel="stylesheet" href="./rl-tools/static/extrack_ui/index.css">
    <script type="importmap">
        {
            "imports": {
                "three": "./rl-tools/static/extrack_ui/lib/three.js",
                "three-orbitcontrols": "./rl-tools/static/extrack_ui/lib/three.js",
                "chart.js": "./rl-tools/static/extrack_ui/lib/chart.js",
                "pako": "./rl-tools/static/extrack_ui/lib/dependencies.js"
            }
        }
    </script>
    <script type="module">
        const curated_base_path = "/./runs/curated/experiments/"
        const ci_base_path = "/./runs/ci/experiments/"

        import { StaticFileSystem } from "./rl-tools/static/extrack_ui/StaticFileSystem.js";

        import { group_by} from "./rl-tools/static/extrack_ui/Index.js";
        import { MultiSourceIndex } from "./rl-tools/static/extrack_ui/MultiSourceIndex.js";
        import { ShowRun } from "./rl-tools/static/extrack_ui/ShowRun.js";


        window.group_by = group_by // make available in the developer console
        
        // Create file systems for both curated and CI runs
        const fs_curated = new StaticFileSystem(curated_base_path)
        const fs_ci = new StaticFileSystem(ci_base_path)
        
        // Create multi-source index
        const idx = new MultiSourceIndex([
            { fs: fs_curated, label: "curated" },
            { fs: fs_ci, label: "ci" }
        ])
        window.idx = idx
        const idx_promise = idx.refresh()

        const env_ranking = [
            "acrobot-swingup-v0",
            "bottleneck-v0",
            "l2f"
        ].reverse()

        idx_promise.then(() => {
            const runs_with_ui = idx.run_list.filter(run => run.ui_jsm)
            const runs_with_steps = runs_with_ui.filter((run) => {
                if(run.steps && Object.keys(run.steps).length > 0){
                    return Object.values(run.steps).some(step => step.trajectories_compressed)
                }
                return false
            })
            const runs_zoo = runs_with_steps.filter(run => run.config.name === "zoo")
            
            // Group by actual population configuration (algorithm + environment)
            // rather than path-based population_values to avoid duplicates across sources
            // Use a canonical key format to handle different key orders in population object
            const runs_by_population = {}
            for(const run of runs_zoo){
                const pop = run.config.population
                // Create canonical key: always use algorithm_environment order
                const key = `${pop.algorithm || 'unknown'}_${pop.environment || 'unknown'}`
                if(!(key in runs_by_population)){
                    runs_by_population[key] = {
                        population: run.config.population,
                        items: []
                    }
                }
                runs_by_population[key].items.push(run)
            }
            // For each group, keep only the most recent run (already sorted by MultiSourceIndex)
            for(const key in runs_by_population){
                runs_by_population[key].items = [runs_by_population[key].items[0]]
            }
            
            const populations = Object.keys(runs_by_population)
            const populations_sorted = populations.sort((a, b) => {
                const example_run_a = runs_by_population[a].items[0]
                const example_run_b = runs_by_population[b].items[0]
                return env_ranking.indexOf(example_run_b.config.population.environment) - env_ranking.indexOf(example_run_a.config.population.environment)
            })
            const container = document.getElementById('latest-zoo-runs-container')
            container.innerHTML = ""
            for(const population_values of populations_sorted){
                const group_runs = runs_by_population[population_values].items
                const title = document.createElement('h2')
                const example_run = group_runs[0]
                title.innerHTML = `<b>Algorithm</b>: ${example_run.config.population.algorithm} </br> Environment: ${example_run.config.population.environment}`
                const this_container = document.createElement('div')
                this_container.classList.add('latest-zoo-runs-container-element')
                this_container.appendChild(title)
                const run_container = document.createElement('div')
                const show_run = new ShowRun(run_container, example_run)
                this_container.appendChild(run_container)
                container.appendChild(this_container)
            }
        })




        import { TableExplorer } from "./rl-tools/static/extrack_ui/TableExplorer.js";
        import { Zoo } from "./rl-tools/static/extrack_ui/Zoo.js";
        
        // Wait for index to load before creating components
        idx_promise.then(() => {
            // Create Zoo first with empty selection
            const zoo = new Zoo([]);
            const zooContainer = document.getElementById('zoo-container');
            zooContainer.appendChild(zoo.getContainer());
            
            // Create TableExplorer with callback to update Zoo
            const tableExplorer = new TableExplorer(idx, {
                onSelectionChange: (selectedRuns) => {
                    zoo.updateRuns(selectedRuns);
                }
            });
            const explorerContainer = document.getElementById('explorer-container');
            explorerContainer.appendChild(tableExplorer.getContainer());
            
            // Wait for table to initialize and set default selections
            tableExplorer.initialized.then(() => {
                // Select last curated group and last 3 CI groups (all seeds in each group)
                const allGroups = tableExplorer.groupedRuns;
                const curatedGroups = allGroups.filter(g => g.source === 'curated');
                const ciGroups = allGroups.filter(g => g.source === 'ci');
                
                // Flatten to get individual runs from selected groups
                const defaultGroups = [
                    ...(curatedGroups.length > 0 ? [curatedGroups[0]] : []),
                    ...ciGroups.slice(0, 3)
                ];
                
                // Extract all individual runs from these groups
                const defaultSelections = defaultGroups.flatMap(g => g.runs);
                
                if (defaultSelections.length > 0) {
                    tableExplorer.setSelectedRuns(defaultSelections);
                }
            });
        });


        fetch("./last_updated.txt")
            .then(response => {
                if (!response.ok) {
                    console.error("HTTP error " + response.status);
                }
                return response.text()
            })
            .then(text => {
                const timestamp = text.trim();
                const date = new Date(timestamp.replace(/ /, 'T').replace(/ /, ''));

                const lastUpdate = document.getElementById('lastUpdate');
                const lastUpdateContainer = document.getElementById('lastUpdateContainer');
                lastUpdate.innerHTML = date.toString();
                lastUpdateContainer.style.display = 'block';
            });
    </script>
</head>
<body>
    <h1>RLtools Zoo Experiment Tracking</h1>
    <div id="lastUpdateContainer" style="display: none">
        This report is automaticall generated by the Github Action CI and was last updated on: <span id="lastUpdate"></span>
    </div>
    <div>For more information about the RLtools Experiment Tracking Interface please refer to the <a href="https://docs.rl.tools/10-Experiment%20Tracking.html">Specification</a></div>
    <h1>Latest Runs</h1>
    <div id="latest-zoo-runs-container">
        Loading...
    </div>
    <h2>Learning Curves</h2>
    <div class="zoo-container-container">
        <div id="zoo-container" class="zoo-container-container-element"></div>
    </div>
    <h2>Run Explorer</h2>
    <div id="explorer-container"></div>
</body>
</html>

